# H&E Color Normalization Algorithm

## Overview
This repository contains scripts necessary to run the image normalization algorithm used in the Melanoma Interoperator Study (manuscript pending publication).

## Running the Algorithm
Please follow the steps outlined below to run the algorithm successfully. Note that the required file organization and process may not be entirely intuitive due to the nature of our development process, where the primary goal was ensuring the algorithmâ€™s functionality rather than optimizing its structure. We encourage users familiar with the code to make their own optimzations and/or modifications if desired to improve the algorithm's flexibility and usability. 

1. **Create a QuPath project and add one or more H&E images**

2. **Create patches from the H&E images**
   - Navigate to the `groovy_files/` directory from the repository.
   - Execute `create_patches.groovy` on the QuPath project (using the "Run for Project" option).
   - Locate the patches in the `tiles/` directory created in your QuPath project folder.

3. **Run the MATLAB Project to color-normalize patches**
   - Download the `matlab_project/` directory from the repository.
   - Move/copy all the patches generated by the previous script into the `matlab_project/orig_ims/` directory.
   - Ensure that the `orig_ims/` directory contains the individual .tif patch files directly, not folders containing these files.
   - Make sure there is a `reference.tif` file in the `orig_ims/` directory and do not remove it. If the `reference.tif` file is broken or missing, attempt to download it raw from the repository again. If issues persist, consider re-cloning the repository using Git LFS to ensure that the file is properly handled.
   - Open the MATLAB environment and execute the `normalizedStaining_runAll.m` script.
   - Locate the color-normalized patches in the `matlab_project/norm_ims/` directory.

4. **Stitch the patches to reconstitute the H&E images**
   - Organize the color-normalized patches generated by the MATLAB script into separate directories based on their original H&E source image.
   - Create a parent directory to hold these organized directories.
   - Open QuPath (no need to create a project) and navigate to `groovy_files/create_patches.groovy` script from the repository.
   - Run the script in QuPath. When prompted, select the parent directory you created as the input directory and specify an output directory for the stitched images.
   - Locate the stitched images in the output directory you specified.

## Dependencies
- QuPath (tested on version 0.5.0)
- MATLAB (tested on version R2023b)
